
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Evaluaci√≥n de Habilidades de Conducci√≥n</title>
    <style>
        body { font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif; margin: 20px; background-color: #f4f7f9; }
        .container { max-width: 600px; margin: auto; background: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 0 10px rgba(0,0,0,0.1); position: relative; }
        h1, h2 { text-align: center; color: #004d99; }
        p.instructions { text-align: center; color: #666; font-style: italic; margin-bottom: 20px; }
        .header-info { display: flex; justify-content: space-between; align-items: center; font-size: 0.9em; margin-bottom: 20px; }
        .header-info span { display: block; }
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-weight: bold; }
        input[type="text"], select, textarea { width: 98%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; }
        #submit-btn {
            background-color: #4CAF50;
            color: white;
            padding: 10px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            width: 100%;
            margin-top: 10px;
            font-size: 1.1em;
        }
        #submit-btn:hover { background-color: #45a049; }
        .question-item { margin-bottom: 20px; padding: 10px; border: 1px solid #eee; border-radius: 4px; background-color: #fafafa; }
        
        /* Estilos del Calendario */
        #calendar-icon {
            position: absolute;
            top: 20px;
            right: 20px;
            cursor: pointer;
            font-size: 1.5em;
            color: #004d99;
            z-index: 10;
        }
        .modal {
            display: none;
            position: fixed;
            z-index: 100;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.7);
        }
        .modal-content {
            background-color: #fefefe;
            margin: 15% auto;
            padding: 20px;
            border: 1px solid #888;
            width: 90%;
            max-width: 500px;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            position: relative;
        }
        .close-btn { color: #aaa; float: right; font-size: 28px; font-weight: bold; cursor: pointer; }
        .close-btn:hover, .close-btn:focus { color: #000; text-decoration: none; cursor: pointer; }
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 5px;
            text-align: center;
        }
        .day-name { font-weight: bold; background-color: #f0f0f0; padding: 5px 0; border-radius: 4px; }
        .calendar-day {
            padding: 8px;
            cursor: pointer;
            border-radius: 50%;
            transition: background-color 0.2s;
        }
        .calendar-day:hover { background-color: #e0e0e0; }
        .has-evaluations { background-color: #c8e6c9 !important; font-weight: bold; }
        .current-day { background-color: #004d99; color: white; }
        .current-day:hover { background-color: #003366; }
        .calendar-nav { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .evaluation-list { list-style: none; padding: 0; margin-top: 15px; }
        .evaluation-list li { 
            padding: 10px; 
            margin-bottom: 5px; 
            border: 1px solid #ddd; 
            border-radius: 4px; 
            background-color: #fff;
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            justify-content: space-between;
        }
        .btn-download, .btn-delete {
            padding: 5px 10px;
            margin-left: 5px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9em;
            margin-top: 5px;
        }
        .btn-download { background-color: #004d99; color: white; }
        .btn-download:hover { background-color: #003366; }
        .btn-delete { background-color: #f44336; color: white; }
        .btn-delete:hover { background-color: #d32f2f; }

        /* Estilos para el mensaje modal */
        #message-modal .modal-content {
            margin: 10% auto;
            max-width: 400px;
            text-align: center;
        }
        .modal-message-header {
            padding: 10px 0;
            color: white;
            border-radius: 8px 8px 0 0;
            font-weight: bold;
            font-size: 1.1em;
            margin: -20px -20px 20px -20px;
        }
        .modal-message-header.success { background-color: #4CAF50; }
        .modal-message-header.error { background-color: #f44336; }
        .modal-message-header.warning { background-color: #ff9800; }
        #message-body { margin-bottom: 20px; text-align: left; }
        #message-close-btn { 
            background-color: #004d99; 
            color: white; 
            padding: 8px 20px; 
            border: none; 
            border-radius: 4px; 
            cursor: pointer;
        }
        #message-close-btn:hover { background-color: #003366; }

        .button-group {
            margin-top: 20px;
            text-align: center;
        }
        .button-group button {
            background-color: #607d8b;
            color: white;
            padding: 8px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        .button-group button.hidden {
            display: none;
        }
        .button-group button:hover {
            background-color: #455a64;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Evaluaci√≥n de Habilidades de Conducci√≥n</h1>
        <p class="instructions">examen para checar descarga de JSON</p>
        
        <div id="calendar-icon" title="Ver Evaluaciones Guardadas">üìÖ</div>

        <form id="evaluation-form">
            <div class="form-group">
                <label for="student-names">Alumno:</label>
                <select id="student-names" required>
                    <option value="" disabled selected>Selecciona un alumno</option>
                    <option value="JUANA909	juana">juana</option><option value="PEPE566	pepe">pepe</option><option value="JULIA871	julian">julian</option>
                </select>
            </div>
            
            <div class="form-group">
                <label for="student-name-display">Matr√≠cula (Autom√°tica):</label>
                <input type="text" id="student-name-display" readonly>
            </div>

            <div class="form-group">
                <label for="instructor-names">Instructor:</label>
                <select id="instructor-names" required>
                    <option value="" disabled selected>Selecciona un instructor</option>
                    <option value="Quique">Quique</option><option value="wilson">wilson</option><option value="javi">javi</option>
                </select>
            </div>

            <h2>Criterios de Evaluaci√≥n</h2>
            
                <div class="question-item">
                    <label>Toma el volante en posici√≥n mientras conduce.</label>
                    <select name="q0"><option value="Excelente">Excelente</option><option value="Muy Bien">Muy Bien</option><option value="Regular">Regular</option><option value="Requiere Mejorar">Requiere Mejorar</option><option value="Inaceptable">Inaceptable</option></select>
                </div>
            
                <div class="question-item">
                    <label>reconoce la transmision</label>
                    <select name="q1"><option value="Excelente">Excelente</option><option value="Muy Bien">Muy Bien</option><option value="Regular">Regular</option><option value="Requiere Mejorar">Requiere Mejorar</option><option value="Inaceptable">Inaceptable</option></select>
                </div>
            
                <div class="question-item">
                    <label>asendente</label>
                    <select name="q2"><option value="Excelente">Excelente</option><option value="Muy Bien">Muy Bien</option><option value="Regular">Regular</option><option value="Requiere Mejorar">Requiere Mejorar</option><option value="Inaceptable">Inaceptable</option></select>
                </div>
            
                <div class="question-item">
                    <label>desendente</label>
                    <select name="q3"><option value="Excelente">Excelente</option><option value="Muy Bien">Muy Bien</option><option value="Regular">Regular</option><option value="Requiere Mejorar">Requiere Mejorar</option><option value="Inaceptable">Inaceptable</option></select>
                </div>
            
                <div class="question-item">
                    <label>revisa espejos</label>
                    <select name="q4"><option value="Excelente">Excelente</option><option value="Muy Bien">Muy Bien</option><option value="Regular">Regular</option><option value="Requiere Mejorar">Requiere Mejorar</option><option value="Inaceptable">Inaceptable</option></select>
                </div>
            
            
            <div class="form-group">
                <label for="student-aptitude">Actitud General del Alumno:</label>
                <select id="student-aptitude" required>
                    <option value="Excelente">Excelente</option><option value="Muy Bien">Muy Bien</option><option value="Regular">Regular</option><option value="Requiere Mejorar">Requiere Mejorar</option>
                </select>
            </div>

            <button type="submit" id="submit-btn">Guardar Evaluaci√≥n</button>
        </form>

        <div class="button-group">
            <button id="tools-btn">Herramientas</button>
            <button id="clear-cache-btn" class="hidden">Borrar Evaluaciones Guardadas</button>
        </div>
    </div>

    <!-- Modal para el Calendario -->
    <div id="calendar-modal" class="modal">
        <div class="modal-content">
            <span class="close-btn">&times;</span>
            <h2>Evaluaciones Guardadas</h2>
            <div class="calendar-nav">
                <button id="prev-month">‚Äπ</button>
                <span id="month-year"></span>
                <button id="next-month">‚Ä∫</button>
            </div>
            <div id="calendar-container" class="calendar-grid"></div>
            <ul id="evaluation-list" class="evaluation-list">
                <p>Selecciona un d√≠a del calendario para ver las evaluaciones.</p>
            </ul>
        </div>
    </div>

    <!-- Modal para Mensajes (NO USAR ALERT) -->
    <div id="message-modal" class="modal">
        <div class="modal-content">
            <div class="modal-message-header">
                <span id="message-title"></span>
            </div>
            <p id="message-body"></p>
            <button id="message-close-btn">Aceptar</button>
        </div>
    </div>


    <script>
        
            // Variables globales para la cach√© y el estado
            const EXAM_NAME = 'Evaluaci√≥n de Habilidades de Conducci√≥n'
            const STORAGE_KEY_PREFIX = 'exam_' + EXAM_NAME.replace(/[^a-zA-Z0-9]/g, '_');
            const CALENDAR_STORAGE_KEY = 'calendar_' + STORAGE_KEY_PREFIX;
            const STUDENT_NAMES_KEY = 'student_names';

            // Funci√≥n para mostrar mensajes modales (NO usar alert)
            function showMessage(title, message, type) {
                const modal = document.getElementById('message-modal');
                const titleEl = document.getElementById('message-title');
                const bodyEl = document.getElementById('message-body');
                const header = document.querySelector('.modal-message-header');
                
                titleEl.textContent = title;
                bodyEl.innerHTML = message;

                header.className = 'modal-message-header'; // Reset class
                if (type === 'success') header.classList.add('success');
                else if (type === 'error') header.classList.add('error');
                else if (type === 'warning') header.classList.add('warning');

                modal.style.display = 'block';
            }

            // Funci√≥n para descargar el archivo JSON, compatible con navegadores y Capacitor (APK)
            async function downloadFile(data) {
                // 1. Preparar el nombre del archivo (Asegurando unicidad con milisegundos)
                const matricula = data.idMatricula.toUpperCase().replace(/\s+/g, '').trim();
                // Extraer fecha (YYYY-MM-DD), hora (HH-MM-SS) y milisegundos (MMM)
                const dateTimeParts = data.date.match(/(\d{4}-\d{2}-\d{2})T(\d{2}:\d{2}:\d{2})\.(\d{3})Z/);
                
                if (!dateTimeParts) {
                    showMessage('‚ùå Error de Fecha', 'El formato de fecha en la evaluaci√≥n es inv√°lido. No se puede generar el nombre de archivo.', 'error');
                    return;
                }
                
                const datePart = dateTimeParts[1];
                const timeSecMiliPart = dateTimeParts[2].replace(/:/g, '-') + '-' + dateTimeParts[3]; // HH-MM-SS-MMM
                
                const fileName = `${matricula}_${datePart}_${timeSecMiliPart}.json`;
                const jsonStr = JSON.stringify(data, null, 2);

                // ** L√≥gica de Descarga Nativa (Capacitor) o Web **
                if (window.Capacitor && window.Capacitor.isPluginAvailable('Filesystem')) {
                    try {
                        // Capacitor requiere los datos como Base64
                        const base64Data = btoa(unescape(encodeURIComponent(jsonStr)));
                        
                        // Usar la API nativa de Capacitor Filesystem para escribir el archivo
                        await Capacitor.Plugins.Filesystem.writeFile({
                            path: fileName,
                            data: base64Data,
                            directory: Capacitor.Plugins.Filesystem.Directory.Downloads,
                            encoding: Capacitor.Plugins.Filesystem.Encoding.UTF8,
                            recursive: true
                        });

                        showMessage('‚úÖ Descarga Exitosa', `El archivo **${fileName}** se guard√≥ en la carpeta **Descargas** de tu dispositivo.`, 'success');

                    } catch (e) {
                        console.error('Error al guardar el archivo con Capacitor:', e);
                        showMessage('‚ùå Error Nativo', 'No se pudo guardar el archivo en el m√≥vil. Verifica que la aplicaci√≥n tenga **permiso de almacenamiento** y que el plugin de **Filesystem** est√© instalado.', 'error');
                    }
                } else {
                    // Fallback para Navegadores Web (funciona en WhatsApp/Chrome)
                    try {
                        const blob = new Blob([jsonStr], { type: 'application/json' });
                        const url = URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = fileName;
                        document.body.appendChild(a);
                        a.click();
                        document.body.removeChild(a);
                        URL.revokeObjectURL(url);
                        showMessage('‚ö†Ô∏è Descarga Web', 'Archivo generado. Revisa si tu navegador lo guard√≥ autom√°ticamente.', 'warning');
                    } catch (webError) {
                        console.error('Error de descarga web:', webError);
                        showMessage('‚ùå Error de Descarga', 'El navegador bloque√≥ la descarga.', 'error');
                    }
                }
            }


            // L√≥gica principal de la aplicaci√≥n (Mantenida)
            
            document.addEventListener('DOMContentLoaded', () => {
                const form = document.getElementById('evaluation-form');
                const submitBtn = document.getElementById('submit-btn');
                const studentSelect = document.getElementById('student-names');
                const studentNameInput = document.getElementById('student-name-display');
                const instructorSelect = document.getElementById('instructor-names');
                const evaluationList = document.getElementById('evaluation-list');
                const calendarModal = document.getElementById('calendar-modal');
                const calendarIcon = document.getElementById('calendar-icon');
                const closeBtn = document.querySelector('.modal-content .close-btn');
                const closeMessageBtn = document.getElementById('message-close-btn');
                const messageModal = document.getElementById('message-modal');
                
                let currentMonth = new Date().getMonth();
                let currentYear = new Date().getFullYear();

                // Cargar nombres de alumnos de la √∫ltima sesi√≥n
                const savedStudentNames = localStorage.getItem(STUDENT_NAMES_KEY);
                if (savedStudentNames) {
                    const studentNames = JSON.parse(savedStudentNames);
                    studentNames.forEach(name => {
                        const [matricula, fullName] = name.split('\t');
                        const option = document.createElement('option');
                        option.value = name;
                        option.textContent = fullName;
                        studentSelect.appendChild(option);
                    });
                }
                
                // Actualizar campo de Matr√≠cula (solo lectura)
                studentSelect.addEventListener('change', () => {
                    const selectedValue = studentSelect.value;
                    if (selectedValue) {
                        const matricula = selectedValue.split('\t')[0].trim();
                        studentNameInput.value = matricula;
                    } else {
                        studentNameInput.value = '';
                    }
                });

                // Inicializar Matr√≠cula
                if(studentSelect.value) {
                    studentNameInput.value = studentSelect.value.split('\t')[0].trim();
                }

                // Manejo de la cach√© (Guardar evaluaci√≥n)
                form.addEventListener('submit', (e) => {
                    e.preventDefault();
                    
                    const selectedStudent = studentSelect.value;
                    const idMatricula = selectedStudent.split('\t')[0].trim();
                    const studentFullName = selectedStudent.split('\t')[1].trim();

                    const instructorName = instructorSelect.value;
                    const studentAptitude = document.getElementById('student-aptitude').value;
                    
                    const questions = {};
                    const formData = new FormData(form);

                    for (let [name, value] of formData.entries()) {
                        if (name.startsWith('q')) {
                            const label = document.querySelector(`label[for="${name}"]`).textContent;
                            questions[label] = value;
                        }
                    }

                    const evaluationData = {
                        examName: EXAM_NAME,
                        studentName: studentFullName,
                        idMatricula: idMatricula, // Matr√≠cula limpia
                        instructorName: instructorName,
                        studentAptitude: studentAptitude,
                        date: new Date().toISOString(),
                        questions: questions
                    };

                    // Guardar en LocalStorage para el calendario (Cach√© Offline)
                    const calendarData = JSON.parse(localStorage.getItem(CALENDAR_STORAGE_KEY) || '{}');
                    const todayKey = new Date().toISOString().slice(0, 10); // YYYY-MM-DD
                    
                    if (!calendarData[todayKey]) {
                        calendarData[todayKey] = [];
                    }
                    
                    calendarData[todayKey].push(evaluationData);
                    localStorage.setItem(CALENDAR_STORAGE_KEY, JSON.stringify(calendarData));

                    showMessage('üéâ Guardado Temporalmente', 'La evaluaci√≥n se guard√≥ en el calendario local. Ahora puedes **Descargar el JSON** desde el calendario cuando tengas conexi√≥n.', 'success');
                    form.reset();
                    
                    // Re-inicializar Matr√≠cula
                    if(studentSelect.value) {
                        studentNameInput.value = studentSelect.value.split('\t')[0].trim();
                    }
                });


                // Manejo del Calendario (Offline View)
                const renderCalendar = (month, year) => {
                    const calendarContainer = document.getElementById('calendar-container');
                    const monthYearEl = document.getElementById('month-year');
                    
                    const firstDay = new Date(year, month, 1);
                    const lastDay = new Date(year, month + 1, 0);
                    const daysInMonth = lastDay.getDate();
                    const startingDay = firstDay.getDay(); // 0 = Sunday, 1 = Monday
                    
                    const monthNames = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];
                    monthYearEl.textContent = `${monthNames[month]} ${year}`;

                    calendarContainer.innerHTML = ''; // Limpiar calendario

                    // D√≠as de la semana
                    const dayNames = ['Dom', 'Lun', 'Mar', 'Mi√©', 'Jue', 'Vie', 'S√°b'];
                    dayNames.forEach(day => {
                        const dayNameEl = document.createElement('div');
                        dayNameEl.classList.add('day-name');
                        dayNameEl.textContent = day;
                        calendarContainer.appendChild(dayNameEl);
                    });

                    // Espacios vac√≠os antes del primer d√≠a
                    for (let i = 0; i < startingDay; i++) {
                        calendarContainer.appendChild(document.createElement('div'));
                    }

                    const today = new Date().toISOString().slice(0, 10);
                    const calendarData = JSON.parse(localStorage.getItem(CALENDAR_STORAGE_KEY) || '{}');

                    for (let day = 1; day <= daysInMonth; day++) {
                        const dateString = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                        const dayEl = document.createElement('div');
                        dayEl.classList.add('calendar-day');
                        dayEl.textContent = day;
                        
                        // Resaltar d√≠as con evaluaciones
                        if (calendarData[dateString] && calendarData[dateString].length > 0) {
                            dayEl.classList.add('has-evaluations');
                        }
                        
                        // Resaltar d√≠a actual
                        if (dateString === today) {
                            dayEl.classList.add('current-day');
                        }

                        dayEl.addEventListener('click', () => showEvaluations(dateString, calendarData[dateString] || []));
                        calendarContainer.appendChild(dayEl);
                    }
                };
                
                const showEvaluations = (dateString, evaluations) => {
                    evaluationList.innerHTML = `<h3>Evaluaciones del ${dateString} (${evaluations.length})</h3>`;

                    if (evaluations.length === 0) {
                        evaluationList.innerHTML += '<p>No hay evaluaciones guardadas para esta fecha.</p>';
                        return;
                    }

                    evaluations.forEach((eval, index) => {
                        const listItem = document.createElement('li');
                        listItem.innerHTML = `
                            <strong>${eval.studentName}</strong> - ${eval.instructorName}
                            <br><small>Matr√≠cula: ${eval.idMatricula}</small>
                            <br><small>Hora: ${new Date(eval.date).toLocaleTimeString()}</small>
                        `;
                        
                        // Bot√≥n de Descarga
                        const downloadBtn = document.createElement('button');
                        downloadBtn.textContent = 'Descargar JSON';
                        downloadBtn.classList.add('btn', 'btn-download');
                        downloadBtn.onclick = () => downloadFile(eval);
                        listItem.appendChild(downloadBtn);

                        // Bot√≥n de Eliminar
                        const deleteBtn = document.createElement('button');
                        deleteBtn.textContent = 'Eliminar';
                        deleteBtn.classList.add('btn', 'btn-delete');
                        deleteBtn.onclick = () => deleteEvaluation(dateString, index);
                        listItem.appendChild(deleteBtn);

                        evaluationList.appendChild(listItem);
                    });
                };
                
                const deleteEvaluation = (dateString, index) => {
                    if (confirm('¬øEst√°s seguro de que quieres eliminar esta evaluaci√≥n?')) {
                        const calendarData = JSON.parse(localStorage.getItem(CALENDAR_STORAGE_KEY) || '{}');
                        calendarData[dateString].splice(index, 1);
                        
                        if (calendarData[dateString].length === 0) {
                            delete calendarData[dateString];
                        }
                        
                        localStorage.setItem(CALENDAR_STORAGE_KEY, JSON.stringify(calendarData));
                        renderCalendar(currentMonth, currentYear); // Re-renderizar calendario
                        showEvaluations(dateString, calendarData[dateString] || []); // Re-renderizar lista
                        showMessage('üóëÔ∏è Eliminada', 'La evaluaci√≥n ha sido eliminada permanentemente de la cach√© local.', 'warning');
                    }
                };


                // Eventos del Calendario
                document.getElementById('prev-month').addEventListener('click', () => {
                    currentMonth--;
                    if (currentMonth < 0) {
                        currentMonth = 11;
                        currentYear--;
                    }
                    renderCalendar(currentMonth, currentYear);
                    evaluationList.innerHTML = '<p>Selecciona un d√≠a del calendario.</p>';
                });

                document.getElementById('next-month').addEventListener('click', () => {
                    currentMonth++;
                    if (currentMonth > 11) {
                        currentMonth = 0;
                        currentYear++;
                    }
                    renderCalendar(currentMonth, currentYear);
                    evaluationList.innerHTML = '<p>Selecciona un d√≠a del calendario.</p>';
                });

                calendarIcon.addEventListener('click', () => {
                    renderCalendar(currentMonth, currentYear);
                    evaluationList.innerHTML = '<p>Selecciona un d√≠a del calendario.</p>';
                    calendarModal.style.display = 'block';
                });

                closeBtn.addEventListener('click', () => {
                    calendarModal.style.display = 'none';
                });

                window.onclick = (event) => {
                    if (event.target == calendarModal) {
                        calendarModal.style.display = 'none';
                    }
                    if (event.target == messageModal) {
                        messageModal.style.display = 'none';
                    }
                };

                closeMessageBtn.addEventListener('click', () => {
                    messageModal.style.display = 'none';
                });

                // L√≥gica de Borrado de Cach√© para Herramientas (Opcional)
                document.getElementById('tools-btn').addEventListener('click', () => {
                    document.getElementById('clear-cache-btn').classList.toggle('hidden');
                });

                document.getElementById('clear-cache-btn').addEventListener('click', () => {
                    if (confirm('ADVERTENCIA: ¬øEst√°s seguro de que deseas eliminar TODAS las evaluaciones guardadas en la cach√© de este examen? Esta acci√≥n es irreversible.')) {
                        localStorage.removeItem(CALENDAR_STORAGE_KEY);
                        renderCalendar(currentMonth, currentYear);
                        evaluationList.innerHTML = '<p>La cach√© ha sido limpiada. No hay evaluaciones.</p>';
                        showMessage('üö® Cach√© Eliminada', 'Todas las evaluaciones guardadas para **este examen** han sido borradas.', 'error');
                    }
                });

            });
        
    </script>
</body>
</html>